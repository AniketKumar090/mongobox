<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join MongoBox Queue</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-firestore-compat.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 8px;
            line-height: 1.6;
        }

        .container {
            max-width: min(95vw, 420px);
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .header {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            padding: clamp(20px, 5vw, 30px);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .header h1 {
            font-size: clamp(20px, 5vw, 26px);
            margin-bottom: 8px;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .header p {
            opacity: 0.9;
            font-size: clamp(12px, 3vw, 14px);
            position: relative;
            z-index: 1;
        }

        .content {
            padding: clamp(15px, 4vw, 30px);
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .input-group {
            margin-bottom: clamp(15px, 4vw, 20px);
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            font-size: clamp(12px, 3vw, 14px);
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding: clamp(12px, 3vw, 15px);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: clamp(14px, 3.5vw, 16px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #f7fafc;
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: #e53e3e;
            background: white;
            box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1);
            transform: translateY(-1px);
        }

        .btn {
            width: 100%;
            padding: clamp(12px, 3vw, 15px);
            border: none;
            border-radius: 12px;
            font-size: clamp(14px, 3.5vw, 16px);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(229, 62, 62, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.3);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #e53e3e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error, .success {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: clamp(12px, 3vw, 14px);
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            border-left: 4px solid #e53e3e;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }

        .error.active, .success.active {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .search-input input {
            flex: 3;
            min-width: 0;
        }

        .search-btn {
            flex: 1;
            padding: clamp(12px, 3vw, 15px) clamp(15px, 4vw, 20px);
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: clamp(14px, 3.5vw, 16px);
            flex-shrink: 0;
        }
        
        
        .search-btn:hover {
            background: linear-gradient(135deg, #c53030 0%, #a02828 100%);
            transform: translateY(-1px);
        }

        .search-results, .queue-list {
            max-height: 50vh;
            overflow-y: auto;
            margin-bottom: 20px;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 transparent;
        }

        .search-results::-webkit-scrollbar, .queue-list::-webkit-scrollbar {
            width: 6px;
        }

        .search-results::-webkit-scrollbar-track, .queue-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .search-results::-webkit-scrollbar-thumb, .queue-list::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        .song-item, .queue-item {
            display: flex;
            align-items: center;
            padding: clamp(10px, 3vw, 15px);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 10px;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            gap: clamp(10px, 3vw, 15px);
        }

        .song-item:hover, .queue-item:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            border-color: #e53e3e;
        }

        .song-thumbnail, .queue-thumbnail {
            width: clamp(50px, 12vw, 60px);
            height: clamp(50px, 12vw, 60px);
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .song-info, .queue-info {
            flex: 1;
            min-width: 0;
        }

        .song-title, .queue-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #2d3748;
            font-size: clamp(12px, 3vw, 14px);
            line-height: 1.3;
            display: -webkit-box;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .song-artist, .queue-artist {
            color: #718096;
            font-size: clamp(10px, 2.5vw, 12px);
            display: -webkit-box;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .add-btn {
            padding: clamp(6px, 2vw, 8px) clamp(12px, 3vw, 16px);
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: clamp(10px, 2.5vw, 12px);
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            white-space: nowrap;
        }

        .add-btn:hover {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            transform: translateY(-1px);
        }

        .add-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .queue-status {
            text-align: center;
            padding: clamp(15px, 4vw, 20px);
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }

        .queue-count {
            font-size: clamp(20px, 6vw, 28px);
            font-weight: 700;
            color: #e53e3e;
            margin-bottom: 5px;
        }

        .queue-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: nowrap;
        }

        .queue-actions .btn {
          flex: 1 1 45%;
          white-space: nowrap;
        }

        .empty-state {
            text-align: center;
            padding: clamp(30px, 8vw, 40px) 20px;
            color: #718096;
        }

        .empty-state .emoji {
            font-size: clamp(36px, 10vw, 48px);
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .empty-state p {
            font-size: clamp(12px, 3vw, 14px);
        }

        #recaptcha-container {
            margin: 20px 0;
            display: flex;
            justify-content: center;
        }

        .phone-input {
            display: flex;
            gap: 8px;
            align-items: stretch;
        }

        .country-code {
            width: clamp(70px, 18vw, 80px);
            padding: clamp(12px, 3vw, 15px) clamp(8px, 2vw, 10px);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: #f7fafc;
            text-align: center;
            font-weight: 600;
            font-size: clamp(12px, 3vw, 14px);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .queue-number {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e53e3e;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Responsive breakpoints */
        @media (max-width: 480px) {
            body {
                padding: 4px;
            }
            
            .container {
                border-radius: 16px;
                max-width: 100vw;
            }
            
            .header {
                border-radius: 0;
            }
            
            .search-input {
                flex-direction: row;
                gap: 10px;
            }
            
            .search-btn {
                width: 100%;
            }
            
            .queue-actions {
                flex-direction: row;
            }
        }

        @media (max-width: 320px) {
            .song-item, .queue-item {
                flex-direction: column;
                text-align: center;
            }
            
            .song-thumbnail, .queue-thumbnail {
                width: 80px;
                height: 80px;
            }
        }

        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .container {
                max-width: 450px;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .song-title, .queue-title {
                color: #e2e8f0 !important;
            }
            .container {
                background: rgba(26, 32, 44, 0.95);
                color: #e2e8f0;
            }
            
            .input-wrapper input {
                background: #2d3748;
                color: #e2e8f0;
                border-color: #4a5568;
            }
            
            .song-item, .queue-item {
                background: #2d3748;
                border-color: #4a5568;
                color: #e2e8f0;
            }
            
            .queue-status {
                background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
                border-color: #4a5568;
            }
        }

        /* Animation for queue items */
        .queue-item {
            animation: slideInQueue 0.3s ease-out;
        }

        @keyframes slideInQueue {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Pulse animation for queue count */
        .queue-count.updated {
            animation: pulse 0.6s ease-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); color: #48bb78; }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ MongoBox</h1>
            <p>Join the music queue and add your favorites!</p>
        </div>

        <div class="content">
            <!-- Login Screen -->
            <div id="loginScreen" class="screen active">
                <div class="error" id="loginError"></div>
                
                <div class="input-group">
                    <label for="phoneNumber">Phone Number</label>
                    <div class="phone-input">
                        <div class="country-code">+91</div>
                        <input type="tel" id="phoneNumber" placeholder="Enter your phone number" maxlength="10">
                    </div>
                </div>

                <div id="recaptcha-container"></div>

                <button class="btn btn-primary" onclick="sendVerificationCode()" id="sendCodeBtn" disabled>
                    <span>üì±</span> Send Verification Code
                </button>

                <div class="loading" id="loginLoading">
                    <div class="spinner"></div>
                    <p>Sending verification code...</p>
                </div>
            </div>

            <!-- Verification Screen -->
            <div id="verifyScreen" class="screen">
                <div class="error" id="verifyError"></div>
                <div class="success" id="verifySuccess"></div>

                <p style="text-align: center; margin-bottom: 20px; color: #718096; font-size: clamp(12px, 3vw, 14px);">
                    Enter the 6-digit code sent to your phone
                </p>

                <div class="input-group">
                    <label for="verificationCode">Verification Code</label>
                    <input type="text" id="verificationCode" placeholder="Enter 6-digit code" maxlength="6">
                </div>

                <button class="btn btn-primary" onclick="verifyCode()" id="verifyBtn">
                    <span>‚úÖ</span> Verify & Continue
                </button>

                <button class="btn btn-secondary" onclick="goBack()" style="margin-top: 10px;">
                    <span>‚¨ÖÔ∏è</span> Back
                </button>

                <div class="loading" id="verifyLoading">
                    <div class="spinner"></div>
                    <p>Verifying code...</p>
                </div>
            </div>

            <!-- Main Screen -->
            <div id="mainScreen" class="screen">
                <div class="success" id="mainSuccess"></div>
                <div class="error" id="mainError"></div>

                <div class="queue-status">
                    <div class="queue-count" id="queueCount">0</div>
                    <p>Songs in queue</p>
                </div>

                <div class="queue-actions">
                  <button class="btn btn-secondary" onclick="showSearch()" id="addSongBtn">
                    <span>‚ûï</span> Add Songs
                </button>
                    <button class="btn btn-success" onclick="showQueue()" id="viewQueueBtn">
                        <span>üìã</span> View Queue
                    </button>
                    
                </div>

                <!-- Search Section -->
                <div id="searchSection">
                    <div class="search-container">
                        <div class="search-input">
                            <input type="text" id="searchInput" placeholder="Search for songs...">
                            <button class="search-btn" onclick="searchSongs()">üîç</button>
                        </div>
                    </div>

                    <div class="search-results" id="searchResults">
                        <div class="empty-state">
                            <div class="emoji">üéµ</div>
                            <p>Search for songs to add to the queue!</p>
                        </div>
                    </div>
                </div>

                <!-- Queue Section -->
                <div id="queueSection" style="display: none;">
                    <div class="queue-list" id="queueList">
                        <div class="empty-state">
                            <div class="emoji">üì≠</div>
                            <p>No songs in queue yet!</p>
                        </div>
                    </div>
                </div>

                <div class="loading" id="searchLoading">
                    <div class="spinner"></div>
                    <p>Searching for songs...</p>
                </div>

                <div class="loading" id="queueLoading">
                    <div class="spinner"></div>
                    <p>Loading queue...</p>
                </div>

                <button class="btn btn-secondary" onclick="signOut()" style="margin-top: 20px;">
                    <span>üö™</span> Sign Out
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration - Replace with your actual config
        const firebaseConfig = {
            apiKey: "AIzaSyCTMwHxyQVJb_0l39uMKIqka-pGYszGexw",
            authDomain: "mongobox-79a1f.firebaseapp.com",
            projectId: "mongobox-79a1f",
            storageBucket: "mongobox-79a1f.firebasestorage.app",
            messagingSenderId: "850327601337",
            appId: "1:850327601337:web:97b8ca86cfda6b37e89b68"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let confirmationResult;
        let queueHostUid;
        let currentQueueSongs = [];
        let isViewingQueue = false;

        // Get host UID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        queueHostUid = urlParams.get('uid');

        // Initialize reCAPTCHA
        window.onload = function() {
            initializeRecaptcha();
        };

        function initializeRecaptcha() {
            try {
                if (!window.recaptchaVerifier) {
                    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                        'size': 'normal',
                        'callback': function(response) {
                            console.log('reCAPTCHA solved');
                            document.getElementById('sendCodeBtn').disabled = false;
                        },
                        'expired-callback': function() {
                            console.log('reCAPTCHA expired');
                            document.getElementById('sendCodeBtn').disabled = true;
                        }
                    });
                    
                    window.recaptchaVerifier.render().then(function(widgetId) {
                        console.log('reCAPTCHA rendered successfully');
                        window.recaptchaWidgetId = widgetId;
                    }).catch(function(error) {
                        console.error('Error rendering reCAPTCHA:', error);
                        showError('loginError', 'reCAPTCHA failed to load. Please refresh the page.');
                    });
                }
            } catch (error) {
                console.error('Error initializing reCAPTCHA:', error);
                showError('loginError', 'reCAPTCHA initialization failed. Please refresh the page.');
            }
        }

        // Check authentication state
        auth.onAuthStateChanged((user) => {
            if (user) {
                showScreen('mainScreen');
               // showSearch();
                listenToQueue();
            }
        });

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.classList.add('active');
            setTimeout(() => errorEl.classList.remove('active'), 5000);
        }

        function showSuccess(elementId, message) {
            const successEl = document.getElementById(elementId);
            successEl.textContent = message;
            successEl.classList.add('active');
            setTimeout(() => successEl.classList.remove('active'), 3000);
        }

        function showLoading(elementId, show = true) {
            const loadingEl = document.getElementById(elementId);
            if (show) {
                loadingEl.classList.add('active');
            } else {
                loadingEl.classList.remove('active');
            }
        }

        function showQueue() {
            isViewingQueue = true;
            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('queueSection').style.display = 'block';
            document.getElementById('viewQueueBtn').style.background = 'linear-gradient(135deg, #38a169 0%, #2f855a 100%)';
            document.getElementById('addSongBtn').style.background = '#f7fafc';
            document.getElementById('addSongBtn').style.color = '#4a5568';
            displayQueue();
        }

        function showSearch() {
            isViewingQueue = false;
            document.getElementById('searchSection').style.display = 'block';
            document.getElementById('queueSection').style.display = 'none';
            document.getElementById('addSongBtn').style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
            document.getElementById('addSongBtn').style.color = 'white';
            document.getElementById('viewQueueBtn').style.background = '#f7fafc';
            document.getElementById('viewQueueBtn').style.color = '#4a5568';
        }

        function displayQueue() {
            const queueContainer = document.getElementById('queueList');
            
            if (currentQueueSongs.length === 0) {
                queueContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">üì≠</div>
                        <p>No songs in queue yet!</p>
                    </div>
                `;
                return;
            }

            queueContainer.innerHTML = currentQueueSongs.map((song, index) => `
                <div class="queue-item">
                    <div style="position: relative;">
                        <img src="${song.thumbnail}" alt="Thumbnail" class="queue-thumbnail">
                        <div class="queue-number">${index + 1}</div>
                    </div>
                    <div class="queue-info">
                        <div class="queue-title">${song.title}</div>
                        <div class="queue-artist">${song.artist}</div>
                    </div>
                </div>
            `).join('');
        }

        async function sendVerificationCode() {
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            
            if (!phoneNumber || phoneNumber.length !== 10) {
                showError('loginError', 'Please enter a valid 10-digit phone number');
                return;
            }

            if (!/^\d{10}$/.test(phoneNumber)) {
                showError('loginError', 'Phone number should contain only digits');
                return;
            }

            const fullPhoneNumber = '+91' + phoneNumber;
            
            try {
                showLoading('loginLoading');
                document.getElementById('sendCodeBtn').disabled = true;

                if (!window.recaptchaVerifier) {
                    throw new Error('reCAPTCHA not initialized');
                }

                console.log('Attempting to send verification code to:', fullPhoneNumber);
                
                confirmationResult = await auth.signInWithPhoneNumber(fullPhoneNumber, window.recaptchaVerifier);
                console.log('Verification code sent successfully');
                
                showScreen('verifyScreen');
                showSuccess('verifySuccess', 'Verification code sent successfully!');
                
            } catch (error) {
                console.error('Detailed error sending verification code:', error);
                
                let errorMessage = 'Failed to send verification code. ';
                
                if (error.code === 'auth/invalid-phone-number') {
                    errorMessage += 'Invalid phone number format.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage += 'Too many requests. Please try again later.';
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage += 'Phone authentication is not enabled.';
                } else if (error.code === 'auth/captcha-check-failed') {
                    errorMessage += 'reCAPTCHA verification failed. Please refresh and try again.';
                } else if (error.message && error.message.includes('reCAPTCHA')) {
                    errorMessage += 'Please complete the reCAPTCHA verification.';
                } else {
                    errorMessage += 'Please check your internet connection and try again.';
                }
                
                showError('loginError', errorMessage);
                
                // Reset reCAPTCHA on error
                if (window.recaptchaVerifier) {
                    try {
                        window.recaptchaVerifier.clear();
                        setTimeout(initializeRecaptcha, 1000);
                    } catch (e) {
                        console.error('Error clearing reCAPTCHA:', e);
                    }
                }
                
            } finally {
                showLoading('loginLoading', false);
                document.getElementById('sendCodeBtn').disabled = false;
            }
        }

        async function verifyCode() {
            const code = document.getElementById('verificationCode').value.trim();
            
            if (!code || code.length !== 6) {
                showError('verifyError', 'Please enter a valid 6-digit verification code');
                return;
            }

            try {
                showLoading('verifyLoading');
                document.getElementById('verifyBtn').disabled = true;

                const result = await confirmationResult.confirm(code);
                console.log('User signed in successfully:', result.user);
                
                showScreen('mainScreen');
                listenToQueue();
                showSearch(); 
                
            } catch (error) {
                console.error('Error verifying code:', error);
                showError('verifyError', 'Invalid verification code. Please try again.');
            } finally {
                showLoading('verifyLoading', false);
                document.getElementById('verifyBtn').disabled = false;
            }
        }

        function goBack() {
            showScreen('loginScreen');
            document.getElementById('verificationCode').value = '';
            
            if (window.recaptchaVerifier) {
                try {
                    window.recaptchaVerifier.clear();
                } catch (e) {
                    console.error('Error clearing reCAPTCHA:', e);
                }
            }
            
            setTimeout(initializeRecaptcha, 500);
        }

        function listenToQueue() {
            if (!queueHostUid) {
                showError('mainError', 'Invalid queue link. Please scan the QR code again.');
                return;
            }

            // Listen to queue changes
            db.collection('queues').doc('currentQueue').onSnapshot((doc) => {
                const previousCount = currentQueueSongs.length;
                
                if (doc.exists) {
                    currentQueueSongs = doc.data().songs || [];
                    const newCount = currentQueueSongs.length;
                    
                    const queueCountEl = document.getElementById('queueCount');
                    queueCountEl.textContent = newCount;
                    
                    // Add pulse animation if count increased
                    if (newCount > previousCount) {
                        queueCountEl.classList.add('updated');
                        setTimeout(() => queueCountEl.classList.remove('updated'), 600);
                    }
                    
                    // Update queue display if currently viewing
                    if (isViewingQueue) {
                        displayQueue();
                    }
                } else {
                    currentQueueSongs = [];
                    document.getElementById('queueCount').textContent = '0';
                    if (isViewingQueue) {
                        displayQueue();
                    }
                }
            });
        }

        async function searchSongs() {
            const query = document.getElementById('searchInput').value.trim();
            
            if (!query) {
                showError('mainError', 'Please enter a search term');
                return;
            }

            try {
                showLoading('searchLoading');
                
                const apiKey = 'AIzaSyBJzIb7YbZPPL2XuOGlncntEPwkc0JQpmY';
                const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=10&q=${encodeURIComponent(query)}&type=video&key=${apiKey}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displaySearchResults(data.items || []);
                
            } catch (error) {
                console.error('Error searching songs:', error);
                showError('mainError', 'Failed to search songs. Please check your internet connection.');
            } finally {
                showLoading('searchLoading', false);
            }
        }

        function displaySearchResults(results) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">üòï</div>
                        <p>No songs found. Try a different search term.</p>
                    </div>
                `;
                return;
            }

            resultsContainer.innerHTML = results.map(item => {
                const isInQueue = currentQueueSongs.some(song => song.id === item.id.videoId);
                
                return `
                    <div class="song-item">
                        <img src="${item.snippet.thumbnails.default.url}" alt="Thumbnail" class="song-thumbnail">
                        <div class="song-info">
                            <div class="song-title">${item.snippet.title}</div>
                            <div class="song-artist">${item.snippet.channelTitle}</div>
                        </div>
                        <button class="add-btn" 
                                onclick="addToQueue(event,'${item.id.videoId}', '${item.snippet.title.replace(/'/g, "\\'")}', '${item.snippet.channelTitle.replace(/'/g, "\\'")}', '${item.snippet.thumbnails.default.url}')" 
                                ${isInQueue ? 'disabled' : ''}>
                            ${isInQueue ? '‚úÖ Added' : '‚ûï Add'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function addToQueue(event, videoId, title, artist, thumbnail) {
            if (!auth.currentUser || !queueHostUid) {
                showError('mainError', 'Authentication error. Please try again.');
                return;
            }

            const song = {
                id: videoId,
                title: title,
                artist: artist,
                thumbnail: thumbnail
            };

            try {
                // Check if song already exists in queue
                const queueDoc = await db.collection('queues').doc('currentQueue').get();
                const existingSongs = queueDoc.exists ? (queueDoc.data().songs || []) : [];
                
                const songExists = existingSongs.some(existingSong => existingSong.id === videoId);
                
                if (songExists) {
                    showError('mainError', 'This song is already in the queue!');
                    return;
                }

                // Add to queue
                await db.collection('queues').doc('currentQueue').set({
                    songs: firebase.firestore.FieldValue.arrayUnion(song)
                }, { merge: true });

                
                
                showSuccess('mainSuccess', `Added "${title}" to queue!`);
                event.target.disabled = true;
                event.target.textContent = '‚úÖ Added';
                
            } catch (error) {
                console.error('Error adding to queue:', error);
            }
        }


        function signOut() {
            auth.signOut().then(() => {
                showScreen('loginScreen');
                document.getElementById('phoneNumber').value = '';
                document.getElementById('verificationCode').value = '';
                document.getElementById('searchInput').value = '';
                document.getElementById('searchResults').innerHTML = `
                    <div class="empty-state">
                        <div class="emoji">üéµ</div>
                        <p>Search for songs to add to the queue!</p>
                    </div>
                `;
                currentQueueSongs = [];
                isViewingQueue = false;
                showSearch(); // Reset to search view
            });
        }

        // Event listeners for better UX
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchSongs();
            }
        });

        document.getElementById('phoneNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendVerificationCode();
            }
        });

        document.getElementById('verificationCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyCode();
            }
        });

        // Auto-format phone number input
        document.getElementById('phoneNumber').addEventListener('input', function(e) {
            const value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
        });

        // Auto-format verification code input
        document.getElementById('verificationCode').addEventListener('input', function(e) {
            const value = e.target.value.replace(/\D/g, '');
            e.target.value = value;
        });

        // Handle back button on mobile browsers
        window.addEventListener('popstate', function(e) {
            if (isViewingQueue) {
                showSearch();
            }
        });

        // Prevent zoom on input focus on iOS
        document.addEventListener('touchstart', function() {
            const viewportMeta = document.querySelector('meta[name="viewport"]');
            viewportMeta.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
        });

        // Re-enable zoom after input blur
        document.addEventListener('touchend', function() {
            setTimeout(() => {
                const viewportMeta = document.querySelector('meta[name="viewport"]');
                viewportMeta.content = 'width=device-width, initial-scale=1.0';
            }, 500);
        });
    </script>
</body>
</html>